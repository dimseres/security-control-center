# Журнал изменений

## 1.0.7 — 16.02.2026

### Изменено

#### Бэкапы / Overview
- Во вкладке `Backups -> Overview` кнопки `Создать бэкап сейчас` и `Обновить` перенесены вниз блока `Параметры нового бэкапа`.
- Добавлена новая вкладка `Backups -> Содержимое` для безопасного просмотра состава бэкапа:
- метаданные артефакта (scope, include_files, версия приложения/схемы, checksum),
- контрольные суммы payload-файлов.

#### Восстановление бэкапа
- Перед запуском `pg_restore` добавлена server-side подготовка БД:
- завершение активных подключений (best-effort),
- очистка схемы `public`,
- повторное создание и выдача прав на схему.
- Восстановление переключено на запуск `pg_restore` без `--clean` (очистка выполняется до restore на стороне сервера).
- В шаге `restore_database` сохраняется исходный текст ошибки для диагностики `backups.restore.pg_restore_failed`.

#### Аудит / логи бэкапов
- В аудит создания бэкапа добавлены параметры фактического запуска: `scope` и `include_files`.
- В аудит чтения артефакта добавлен признак ресурса (`resource=artifact|contents`) для разграничения обычного просмотра и просмотра вкладки «Содержимое».

#### Мониторинг
- Устранено повторное создание мониторов при многократном клике: кнопка `Сохранить` блокируется на время submit.
- Убрана лишняя клиентская повторная команда `check-now` после сохранения (проверка запускается server-side), чтобы исключить ошибки гонки/дублирующие запросы.
- Для `create/update/clone` мониторов добавлен server-side запуск немедленной проверки (`CheckNow`) в фоне.
- После сохранения монитора UI теперь ожидает первую server-side проверку и подгружает актуальный `state` сразу (в т.ч. при блокировке приватных сетей), без ожидания планового тика.

#### Бэкапы / Содержимое
- Во вкладке `Backups -> Содержимое` исправлено отображение контрольных сумм payload: теперь корректно показываются `manifest.json` и `db.dump` из `checksums`.
- Для новых бэкапов в метаданные добавлен счетчик `monitoring.monitors`; во вкладке содержимого отображается поле `Мониторы в бэкапе`.
- Во вкладке просмотра бэкапа добавлена таблица состава модулей (документы, инциденты, отчеты, задачи, контроли, пользователи/группы, согласования и т.д.) на основе `entity_counts`.
- Для задач в составе бэкапа счетчики `Доски задач` и `Пространства задач` теперь учитывают только активные записи (`is_active=1`), чтобы не показывать soft-deleted элементы после очистки.

#### Settings / Очистка
- Из списка очистки вкладок убраны пункты `Dashboard` и `Settings`, чтобы не трогать пользовательские базовые предпочтения и служебные настройки.
- Из списка очистки также убраны `Accounts` и `Logs`, где нет безопасного server-side полного удаления данных вкладки.
- Для вкладок `Monitoring`, `Controls`, `Tasks`, `Reports` добавлена server-side очистка данных через API (best-effort удаление сущностей модуля, а не только localStorage).
- Для `Tasks` очистка усилена удалением самих задач (с `include_archived=1`) перед удалением шаблонов/досок/пространств, чтобы не оставались хвосты в бэкапе.
- Для `Controls` в очистке исключены встроенные типы (`is_builtin`), чтобы не падать на `controls.types.builtin`.
- Ошибки очистки теперь показываются через i18n-перевод, а не сырым кодом.

#### Monitoring / UX
- После удаления мониторов в процессе очистки устранен циклический `404` в detail-polling: при `common.notFound` выбранный монитор сбрасывается и список перезагружается.

#### Время / контейнер
- Генерация timestamp в имени файла бэкапа переведена на локальную таймзону контейнера (`TZ`), с fallback на `Europe/Moscow` (вместо жесткого UTC в имени файла).
- Подготовлен локальный compose-файл `docker-compose.local.yml` с единым `TZ` для сервисов `berkut/postgres/nginx/onlyoffice`.
- В `.env.example` добавлен параметр `TZ=Europe/Moscow`.
- Документация и пример `docs/ru/docker-compose.https.yml` обновлены под единый timezone runtime.

### Версия
- Версия приложения обновлена до `1.0.7`.
